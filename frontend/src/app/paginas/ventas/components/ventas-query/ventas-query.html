<div class="py-4">
  <mat-card class="p-5 rounded-2xl! dark:bg-gray-700!">
    <!-- FILTROS -->
    <form [formGroup]="filtrosForm" (ngSubmit)="obtenerVentas()" class="flex gap-5 mb-6">
      <mat-form-field appearance="fill">
        <mat-label>Seleccionar filtro</mat-label>
        <mat-select (selectionChange)="handleSelectChange($event)">
          @for (fil of selectFiltros(); track $index) {
          <mat-option [value]="fil.value">{{ fil.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (filtroSeleccionado() === 'cliente') {
      <mat-form-field appearance="fill">
        <mat-label>Tipo de documento</mat-label>
        <mat-select formControlName="tipoDocumento">
          @for (td of tiposDocumento(); track $index) {
          <mat-option [value]="td">{{ td }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Documento</mat-label>
        <input matInput formControlName="documento" placeholder="Número de documento" />
      </mat-form-field>
      }@else if (filtroSeleccionado() === 'estado') {
      <mat-form-field appearance="fill">
        <mat-label>Estados</mat-label>
        <mat-select formControlName="estado">
          <mat-option value="Todos">Todos</mat-option>
          @for (td of selectEstadosVentas(); track $index) {
          <mat-option [value]="td.value">{{ td.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      }@else if (filtroSeleccionado() === 'rangoFecha') {
      <mat-form-field appearance="fill">
        <mat-label>Ingrese dos fechas</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Fecha de inicio" formControlName="desde" />
          <input matEndDate placeholder="Fecha de fin" formControlName="hasta" />
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
      }@if (filtroSeleccionado() != null) {
      <button
        mat-flat-button
        color="primary"
        class="bg-blue-600 hover:bg-blue-500 h-14 p-2 rounded text-white"
        type="submit"
      >
        Buscar
      </button>
      }
    </form>

    <!-- TABLA -->
    <div class="overflow-x-auto rounded-lg">
      <table
        mat-table
        [dataSource]="datasource()"
        class="min-w-full border border-gray-200! dark:border-gray-700! rounded-lg"
      >
        <!-- Nombre cliente -->
        <ng-container matColumnDef="cliente">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="text-left py-3 px-4 font-semibold bg-gray-100! dark:bg-[#0f172a]!"
          >
            Cliente
          </th>
          <td mat-cell *matCellDef="let element" class="py-3 px-4 border-t dark:border-gray-800!">
            {{ element.clienteId.nombre }}
          </td>
        </ng-container>

        <!-- Fecha venta -->
        <ng-container matColumnDef="fecha">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="text-left py-3 px-4 font-semibold bg-gray-100! dark:bg-[#0f172a]!"
          >
            Fecha
          </th>
          <td mat-cell *matCellDef="let element" class="py-3 px-4 border-t dark:border-gray-800!">
            {{ element.fechaCreacion | date : 'yyyy-MM-dd' }}
          </td>
        </ng-container>

        <!-- Total venta -->
        <ng-container matColumnDef="total">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="text-left py-3 px-4 font-semibold bg-gray-100! dark:bg-[#0f172a]!"
          >
            Total
          </th>
          <td mat-cell *matCellDef="let element" class="py-3 px-4 border-t dark:border-gray-800!">
            {{ element.total | currency : 'COP' }}
          </td>
        </ng-container>

        <!-- Estado venta -->
        <ng-container matColumnDef="estado">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="text-left py-3 px-4 font-semibold bg-gray-100! dark:bg-[#0f172a]!"
          >
            Estado
          </th>
          <td mat-cell *matCellDef="let element" class="py-3 px-4 border-t dark:border-gray-800!">
            <span
              [ngClass]="{
                'text-yellow-500': element.estado === 'ACTIVA',
                'text-green-500': element.estado === 'FINALIZADA',
                'text-red-500': element.estado === 'CANCELADA'
              }"
              >{{ element.estado }}</span
            >
          </td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="acciones">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="text-left py-3 px-4 font-semibold bg-gray-100! dark:bg-[#0f172a]!"
          >
            Acciones
          </th>
          <td mat-cell *matCellDef="let element" class="py-3! flex gap-2">
            <button
              mat-flat-button
              class="bg-cyan-600! hover:bg-cyan-500! text-white px-3 py-1 rounded-md"
              (click)="verDetalle(element)"
            >
              Detalles
            </button>
            <button
              mat-flat-button
              class="bg-green-600! hover:bg-green-500! text-white px-3 py-1 rounded-md disabled:bg-green-400!"
              [disabled]="element.estado !== 'ACTIVA'"
              (click)="realizarPago(element)"
            >
              Pagar
            </button>
            <button
              mat-flat-button
              class="bg-red-600! hover:bg-red-500! text-white px-3 py-1 rounded-md disabled:bg-red-400!"
              [disabled]="element.estado !== 'ACTIVA'"
              (click)="anularVenta(element.id)"
            >
              Anular
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnas" class="text-sm"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: columnas"
          class="hover:bg-gray-50! dark:hover:bg-[#1e293b]/70!"
        ></tr>
      </table>
    </div>
  </mat-card>
</div>

<!-- MODAL DETALLE -->
<ng-template #detalleVenta let-data>
  <h2 mat-dialog-title>Detalle de Venta</h2>
  <mat-dialog-content>
    @for (d of data.detalles; track $index) {
    <div class="flex justify-between border-b py-2">
      <span>{{ d.productoId.nombre }} (x{{ d.cantidad }})</span>
      <span>{{ d.subtotal | currency : 'COP' }}</span>
    </div>
    }
    <div class="text-right font-semibold mt-4">Total: {{ data.total | currency : 'COP' }}</div>
  </mat-dialog-content>
</ng-template>

<ng-template #modalpago let-ventaData>
  <h2 mat-dialog-title>Detalles del pago</h2>
  <mat-dialog-content>
    <form [formGroup]="pagoForm">
      <mat-form-field appearance="fill" class="w-full mb-4">
        <mat-label>Método de pago</mat-label>
        <mat-select formControlName="metodoPago">
          @for (metodo of metodosPago(); track $index) {
          <mat-option [value]="metodo">{{ metodo }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="fill" class="w-full mb-4">
        <mat-label>Monto</mat-label>
        <input matInput type="number" formControlName="monto" min="0" />
      </mat-form-field>
      <div class="flex justify-end mt-4">
        <button
          mat-flat-button
          color="primary"
          class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded"
          [disabled]="pagoForm.invalid"
          (click)="confirmarPago(ventaData.id)"
        >
          Confirmar Pago
        </button>
      </div>
    </form>
  </mat-dialog-content>
</ng-template>
